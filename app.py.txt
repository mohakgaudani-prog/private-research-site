from flask import Flask, render_template, request, redirect, session, send_file
import os
from PyPDF2 import PdfReader
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas


app = Flask(__name__)
app.secret_key = "super_private_key_123"


UPLOAD_FOLDER = "uploads"
OUTPUT_FOLDER = "outputs"


os.makedirs(UPLOAD_FOLDER, exist_ok=True)
os.makedirs(OUTPUT_FOLDER, exist_ok=True)


# CHANGE THESE LATER
USERNAME = "admin"
PASSWORD = "1234"




@app.route("/", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        if request.form["username"] == USERNAME and request.form["password"] == PASSWORD:
            session["user"] = True
            return redirect("/dashboard")
    return render_template("login.html")




@app.route("/dashboard", methods=["GET", "POST"])
def dashboard():
    if not session.get("user"):
        return redirect("/")


    if request.method == "POST":
        pdf = request.files["pdf"]
        pdf_path = os.path.join(UPLOAD_FOLDER, pdf.filename)
        pdf.save(pdf_path)


        reader = PdfReader(pdf_path)
        full_text = ""
        for page in reader.pages:
            if page.extract_text():
                full_text += page.extract_text()


        analysis_text = """
PRIVATE MARKET ANALYSIS REPORT


This report is generated for private research use.


Key Observations:
- Business-related information detected
- Market-impacting signals identified
- Investor relevance present


(This is placeholder analysis.
AI-based deep analysis will be added next.)
"""


        output_pdf = os.path.join(OUTPUT_FOLDER, "analysis.pdf")
        c = canvas.Canvas(output_pdf, pagesize=A4)
        width, height = A4


        y = height - 40
        for line in analysis_text.split("\n"):
            c.drawString(40, y, line)
            y -= 14
            if y < 40:
                c.showPage()
                y = height - 40


        c.save()


        return redirect("/result")


    return render_template("dashboard.html")




@app.route("/result")
def result():
    if not session.get("user"):
        return redirect("/")
    return render_template("result.html")




@app.route("/download")
def download():
    return send_file("outputs/analysis.pdf", as_attachment=True)




@app.route("/logout")
def logout():
    session.clear()
    return redirect("/")




if __name__ == "__main__":
    app.run(host="0.0.0.0", port=10000)